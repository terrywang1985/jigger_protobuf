# 游客登录功能实现 (修正版)

## 概述

本实现为jigger_protobuf项目添加了游客登录功能，允许客户端在不注册账号的情况下直接进入游戏。

**重要说明**：游客登录完全绕过平台认证服务，由LoginServer和GameServer内部处理。只有在用户主动选择绑定账号时，才会与平台认证服务交互。

## 设计理念

### 🎯 正确的游客登录流程

1. **游客阶段**：完全独立于平台，直接在游戏服务器端管理
2. **绑定阶段**：用户主动触发时，才与平台认证服务交互
3. **数据迁移**：绑定时将游客数据迁移到正式账号

### ❌ 错误理解 vs ✅ 正确理解

| 错误理解 | 正确理解 |
|---------|----------|
| 游客登录也要调用平台服务 | 游客登录绕过平台服务 |
| 一开始就创建平台账号 | 游客数据仅存储在游戏服务器 |
| 游客就是简化的正式用户 | 游客是临时的本地用户 |

## 架构改动

### 1. 登录服务器 (jigger_protobuf/server/src/servers/login)

**核心改动：**
- `processGuestLogin()` 函数完全重写，不再调用平台服务
- 直接在本地创建游客session，使用 `guest_设备ID` 格式的OpenID
- 游客session完全独立管理

### 2. 游戏服务器 (jigger_protobuf/server/src/servers/game)

**核心改动：**
- `handleGuestAuth()` 函数验证游客session
- `findOrCreateGuestUserLocal()` 在本地创建游客用户数据
- 游客用户数据存储在Redis中，与正式用户隔离

### 3. 平台认证服务保持不变

**重要**：平台认证服务不处理游客登录，保持现有功能不变。

## 游客登录流程 (修正版)

### 游客登录阶段
```
客户端                    LoginServer              游戏服务器
  |                          |                         |
  |-- 游客登录请求 ----------->|                         |
  |   {device_id, app_id}     |                         |
  |                          |-- 本地创建游客session |
  |                          |   guest_设备ID       |
  |<-- 返回会话信息 -----------|                         |
  |   {session_id, ...}       |                         |
  |                          |                         |
  |-- 连接游戏服务器 ----------------------->。|
  |   WebSocket连接           |                         |
  |                          |                         |
  |-- 认证请求 -------------------------------->|
  |   {session_id, is_guest}  |                         |
  |                          |<-- 本地验证session |
  |                          |    创建游戏用户数据 |
  |<-- 认证响应 --------------------------------|
  |   {success, user_info}    |                         |
```

### 后续绑定阶段 (待实现)
```
客户端                    游戏服务器              平台认证服务
  |                          |                         |
  |-- 绑定请求 ------------------>|                         |
  |   {手机号/邮箱, 验证码}    |                         |
  |                          |-- 调用平台认证 ------->。|
  |                          |   {游客数据, 新账号信息} |
  |                          |<-- 绑定结果 -----------|
  |                          |    {成功/失败}        |
  |<-- 绑定结果 ----------------|
  |   {成功, 新的token}      |
```

## 使用方法

### 1. 启动服务

```bash
# 启动登录服务器
cd jigger_protobuf/server/src/servers/login
go run .

# 启动游戏服务器
cd jigger_protobuf/server/src/servers/game
go run .

# 注意：游客登录不需要启动平台认证服务
```

### 2. 游客登录测试

```bash
# 运行游客登录测试客户端
cd jigger_protobuf/client
python guest_auth_client.py
```

### 3. 客户端集成示例

```python
# 游客登录请求（直接调用LoginServer）
login_data = {
    "device_id": "device_abc123",
    "app_id": "jigger_game",
    "is_guest": True
}

response = requests.post("http://localhost:8081/guest-login", json=login_data)
session_info = response.json()

# 使用返回的session_id连接游戏服务器
# ...
```

## 游客账号特点

1. **完全本地化**: 游客数据仅存储在游戏服务器，不涉及平台
2. **设备绑定**: 同一设备ID会对应同一个游客账号
3. **功能完整**: 游客可以正常游戏，包括抽卡、战斗等功能
4. **临时性质**: 建议引导用户绑定正式账号以保障数据安全
5. **独立管理**: 游客数据与正式用户数据完全隔离

## 数据存储

### Redis存储结构
```
# 游客用户映射
openid_to_uid:guest_device123 -> "游戏内用户ID"

# 游戏用户数据
user:游戏内用户ID -> {
    nickname: "guest_device123",
    exp: 0,
    gold: 100,
    diamond: 10,
    ...
}

# 游客会话数据
session:sessionID -> {
    openid: "guest_device123",
    username: "guest_device123",
    app_id: "jigger_game",
    ...
}
```

## 后续扩展

1. **账号绑定**: 实现游客账号与手机号/邮箱账号的绑定
2. **数据迁移**: 绑定时将游客数据迁移到正式账号
3. **游客限制**: 可以对游客账号添加一些功能限制
4. **清理机制**: 定期清理长时间未使用的游客账号

## 与平台服务的交互时机

### 🚫 游客登录阶段 - 不与平台交互
- 设备ID生成游客标识
- 本地创建临时用户数据
- 游戏功能完全可用

### ✅ 账号绑定阶段 - 开始与平台交互
- 用户主动选择绑定手机号/邮箱
- 调用平台认证服务验证身份
- 将游客数据迁移到正式平台账号

## 注意事项

1. **数据安全**: 游客数据仅存储在游戏服务器，建议及时引导绑定
2. **设备ID管理**: 客户端需要妥善保存设备ID
3. **protobuf重新生成**: 修改proto文件后需要重新生成protobuf代码
4. **清理策略**: 需要定期清理长期未使用的游客数据

## 测试建议

1. 使用不同设备ID测试多个游客账号
2. 测试游客账号的游戏功能完整性  
3. 测试游客账号数据的持久化
4. 测试重复登录的一致性
5. 验证游客数据与正式用户数据的隔离性