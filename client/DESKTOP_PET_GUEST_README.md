# 桌面宠物游客登录功能说明

## 概述

这个修改版本的 `client11.py` 增加了游客登录功能，让用户可以快速体验桌面宠物的多人在线功能，包括：

1. **游客登录** - 无需手机号验证码，快速登录
2. **多玩家互动** - 玩家之间可以互相看到
3. **聊天功能** - 在聊天室内实时聊天
4. **动作同步** - 宠物动作会同步给其他玩家

## 主要修改

### 1. AuthManager 类增强
- 添加了 `guest_login()` 方法
- 自动生成设备ID用于游客身份识别
- 支持游客和正常用户两种登录方式

### 2. DesktopPet 类优化
- 修改为接收 `client` 对象而不是 `ws` 连接
- 改进聊天和动作消息发送格式
- 支持位置信息同步

### 3. HomePage 界面改进
- 在登录界面添加了"游客登录"按钮
- 支持快速游客登录体验
- 创建 `JiggerClientForHome` 类支持HomePage中的WebSocket连接

### 4. 消息处理增强
- 支持 protobuf 和 JSON 混合消息格式
- 添加桌面宠物专用消息类型（pet_chat, pet_action）
- 支持多玩家加入/离开通知

## 使用方法

### 方法一：使用新的启动脚本（推荐）
```bash
cd client
python desktop_pet_guest.py
```

### 方法二：使用原有程序
```bash
cd client
python client11.py
```
然后在主页中选择"游客登录"选项。

## 功能特性

### 游客登录
- 一键快速登录，无需手机号验证
- 自动分配游客用户名和OpenID
- 保持与正常用户相同的游戏体验

### 多玩家互动
- 实时看到其他在线玩家的桌面宠物
- 宠物移动、点击等动作会同步给其他玩家
- 支持最多多个玩家同时在线

### 聊天系统
- 在宠物底部输入框输入消息
- 按回车发送聊天消息
- 其他玩家会看到聊天气泡显示

### 操作说明
- **拖动宠物**：鼠标左键拖动可移动宠物位置
- **右键菜单**：右键点击宠物显示功能菜单
- **发送聊天**：在底部输入框输入文字，按回车发送
- **触发动作**：鼠标点击或键盘按键会触发动作动画

## 服务器要求

确保以下服务正在运行：

1. **登录服务器** (端口 8081)
   ```bash
   cd server
   go run src/servers/login/loginserver.go
   ```

2. **游戏服务器** (端口 18080)
   ```bash
   cd server
   go run src/servers/game/*.go
   ```

3. **Redis 服务器** (端口 6379)
   - 用于存储会话和用户数据

## 技术实现

### 游客登录流程
1. 客户端生成唯一设备ID
2. 向登录服务器发送游客登录请求 (`is_guest: true`)
3. 登录服务器创建游客会话，返回 session_id
4. 客户端使用 session_id 连接游戏服务器
5. 游戏服务器验证会话，允许游客进入游戏

### 消息同步机制
- 使用 WebSocket 进行实时通信
- **纯Protobuf协议**：所有消息都必须为protobuf格式
- 使用 `GAME_ACTION_NOTIFICATION` 消息ID实现桌面宠物同步
- 消息体包含4字节长度头 + protobuf `Message` 数据
- 动作/聊天数据以JSON格式嵌入在protobuf消息的data字段中
- 消息缓冲和批量处理机制，减少了网络往返次数

### 多玩家管理
- 服务器维护在线玩家列表
- 新玩家加入时通知其他玩家
- 玩家离开时清理相关资源
- 支持玩家昵称和状态显示

## 注意事项

1. **网络要求**：需要能访问本地的登录服务器和游戏服务器
2. **精灵图片**：需要 `spritesheet.png` 文件作为宠物外观
3. **依赖模块**：确保安装了所有必要的 Python 模块
4. **端口占用**：确保 8081 和 18080 端口未被其他程序占用

## 故障排除

### 连接失败
- 检查服务器是否正常运行
- 确认端口是否开放
- 查看服务器日志获取详细错误信息

### 登录失败
- 检查登录服务器是否支持游客登录
- 确认 Redis 服务器连接正常
- 查看设备ID是否正确生成

### 消息不同步
- 确认 WebSocket 连接正常
- 检查消息格式是否正确
- 查看客户端和服务器日志

## 扩展功能

未来可以考虑添加：

1. **皮肤系统**：支持更换宠物外观
2. **房间系统**：支持创建私人聊天室
3. **好友系统**：添加好友列表功能
4. **表情系统**：更丰富的宠物动作表情
5. **语音聊天**：支持语音通信功能

## 开发者信息

这个功能基于原有的 `client11.py` 进行扩展，保持了原有功能的同时添加了游客登录和多人互动特性。代码结构清晰，易于进一步扩展和维护。